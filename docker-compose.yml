services:
  gitlab:
    image: gitlab/gitlab-ce:16.3.4-ce.0
    container_name: gitlab
    restart: always
    hostname: ${GITLAB_HOST}
    shm_size: 256m
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url '${GITLAB_URL}'
        gitlab_rails['backup_keep_time'] = 604800
        gitlab_rails['gitlab_ssh_host'] = '${GITLAB_SSH_HOST}'
        gitlab_rails['gitlab_shell_ssh_port'] = ${GITLAB_SSH_PORT}
        nginx['listen_port'] = 80
        nginx['redirect_http_to_https'] = false
        
        # Fix shared memory issues for Prometheus
        prometheus['enable'] = ${PROMETHEUS_ENABLE}
        prometheus['flags'] = {
          'storage.tsdb.path' => "/var/opt/gitlab/prometheus/data",
          'storage.tsdb.retention.time' => "15d",
          'config.file' => "/var/opt/gitlab/prometheus/prometheus.yml"
        }
        
        # Reduce Prometheus scrape frequency to reduce shm pressure
        prometheus['scrape_interval'] = ${PROMETHEUS_SCRAPE_INTERVAL}
        prometheus['scrape_timeout'] = 10
        
        # Grafana configuration
        grafana['enable'] = ${GRAFANA_ENABLE}
        
        # Reduce memory pressure
        puma['worker_processes'] = 2
        puma['max_threads'] = 4
        sidekiq['max_concurrency'] = 10
        
        # SMTP Configuration
        gitlab_rails['smtp_enable'] = ${SMTP_ENABLE}
        gitlab_rails['smtp_address'] = '${SMTP_ADDRESS}'
        gitlab_rails['smtp_port'] = ${SMTP_PORT}
        gitlab_rails['smtp_user_name'] = '${SMTP_USER_NAME}'
        gitlab_rails['smtp_password'] = '${SMTP_PASSWORD}'
        gitlab_rails['smtp_domain'] = '${SMTP_DOMAIN}'
        gitlab_rails['smtp_authentication'] = '${SMTP_AUTHENTICATION}'
        gitlab_rails['smtp_enable_starttls_auto'] = ${SMTP_ENABLE_STARTTLS_AUTO}
        gitlab_rails['smtp_tls'] = ${SMTP_TLS}
        gitlab_rails['gitlab_email_from'] = '${SMTP_USER_NAME}'
        gitlab_rails['gitlab_email_reply_to'] = '${SMTP_USER_NAME}'
    ports:
      - "${GITLAB_HTTP_PORT}:80"
      - "${GITLAB_SSH_PORT}:22"
    volumes:
      - ./data/config:/etc/gitlab
      - ./data/logs:/var/log/gitlab
      - ./data/data:/var/opt/gitlab
      - ${BACKUP_PATH}:/backups
    tmpfs:
      - /dev/shm:size=256m,noexec,nosuid,nodev
      - /tmp:size=512m,noexec,nosuid,nodev
    networks:
      - gitlab_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/-/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  gitlab-backup:
    image: gitlab/gitlab-ce:16.3.4-ce.0
    container_name: gitlab-backup
    restart: unless-stopped
    environment:
      - CRON_SCHEDULE=${BACKUP_SCHEDULE}
      - BACKUP_RETENTION_DAYS=${BACKUP_RETENTION_DAYS}
    volumes:
      - ./data/config:/etc/gitlab:ro
      - ./data/logs:/var/log/gitlab:ro
      - ./data/data:/var/opt/gitlab:ro
      - ${BACKUP_PATH}:/backups
      - ./scripts:/scripts:ro
    networks:
      - gitlab_net
    depends_on:
      - gitlab
    entrypoint: |
      sh -c '
        echo "Installing cron and required packages..."
        apt-get update && apt-get install -y cron curl
        
        echo "Setting up backup cron job..."
        echo "$${CRON_SCHEDULE} /scripts/backup-cron.sh >> /var/log/backup.log 2>&1" > /etc/crontab
        
        echo "Starting cron daemon..."
        cron -f
      '

networks:
  gitlab_net:
    driver: bridge
